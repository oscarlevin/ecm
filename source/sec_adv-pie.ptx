<?xml version="1.0" encoding="UTF-8"?>
<section xmlns:xi="http://www.w3.org/2001/XInclude" xml:id="sec_adv-pie">
  <title>The Principle of Inclusion and Exclusion: the Size of a Union</title>

  <introduction>
      <p>
        One of our very first counting
        principles was the <term>sum principle</term><idx><h>sum principle</h></idx> which says that
        the size of a union of disjoint sets is the sum of their sizes.
        Computing the size of overlapping sets requires, quite naturally,
        information about how they overlap. Taking such information into account
        will allow us to develop a powerful extension of the sum principle known
        as the <q>principle of inclusion and exclusion.</q><idx><h>principle of
        inclusion and exclusion</h></idx><idx><h>inclusion and exclusion principle</h></idx>
      </p>
  </introduction>
  <subsection>
    <title>Unions of two or three sets</title>
      <activity xml:id="fertilizer2" category="motivation">
        <statement>
          <p> In a biology lab study of the effects of basic fertilizer
          ingredients on plants, 16 plants are treated with potash, 16 plants are
          treated with phosphate, and among these plants, eight are treated with
          both phosphate and potash. No other treatments are used. How many plants
          receive at least one treatment? If 32 plants are studied, how many
          receive no treatment?
          </p>
        </statement>
        <solution>
          <p>
            The number of plants receiving treatment was <m>16+16-8 = 24</m>.
            The number of plants receiving no treatment was eight.
          </p>
        </solution>
      </activity>

      <activity xml:id="twosetintersection" category="summary">
        <statement>
          <p>
            Give a formula for the size of the union <m>A\cup B</m> of two
            sets
            <m>A</m> in terms of the sizes <m>|A|</m> of <m>A</m>, <m>|B|</m> of <m>B</m>, and <m>|A\cap B|</m> of
            <m>A\cap B</m>. If <m>A</m> and <m>B</m> are subsets of some <q>universal</q> set <m>U</m>,
            express the size of the complement <m>U-(A\cup B)</m> in terms of the sizes
            <m>|U|</m> of <m>U</m>, <m>|A|</m> of <m>A</m>, <m>|B|</m> of <m>B</m>, and <m>|A\cap B|</m> of
            <m>A\cap B</m>.
          </p>
        </statement>
        <hint>
          <p>
            Try drawing a Venn Diagram.
          </p>
        </hint>
        <solution>
          <p>
            <m>|A\cup B|=|A| + |B| - |A\cap B|</m>.
          </p>

          <p>
            <m>|U-(A\cup B)| = |U|-|A|-|B| + |A
            \cap B|</m>.
          </p>
        </solution>
      </activity>

      <activity category="motivation">
        <statement>
          <p>
            In <xref ref="fertilizer2"/>, there were just two fertilizers used
            to treat the sample plants. Now suppose there are three fertilizer
            treatments, and 15 plants are treated with nitrates, 16 with potash, 16
            with phosphate, 7 with nitrate and potash, 9 with nitrate and phosphate,
            8 with potash and phosphate and 4 with all three. Now how many plants
            have been treated? If 32 plants were studied, how many received no
            treatment at all?
          </p>
        </statement>
        <solution>
          <p>
            <m>15+16+16-7-9-8+4=27</m> plants were treated and five received
            no treatment.
          </p>
        </solution>
      </activity>
      
      

      <activity xml:id="threesetintersection" category="essential">
        <statement>
          <p>
            A formula for the size of <m>A\cup B\cup C</m> in terms of
            the sizes of <m>A</m>, <m>B</m>, <m>C</m> and the intersections of these sets is 
            <me>|A\cup B\cup C|=|A|+|B|+|C|-|A\cap B|- |A\cap C| - |B\cap
              C| +|A\cap B\cap C|</me>.
          </p>
          <sidebyside widths="65% 25%" margins="0% 0%" valign="top">
            <p>
              Explain why this is correct using a Venn diagram. In particular, how many times are elements are in <m>A \cap B \cap C</m> counted?  What about the other regions of the Venn diagram?
            </p>
            <image xml:id="three-set-empty-PIE">
              <latex-image>
                \begin{tikzpicture}[scale=.60, fill=gray!50]
                \draw[thick] \circleA \circleAlabel \circleB \circleBlabel \circleC \circleClabel \threesetbox;
                \end{tikzpicture}
              </latex-image>
            </image>
            
          </sidebyside>
        </statement>
      </activity>



    </subsection>

    <subsection>
      <title>Unions of an arbitrary number of sets</title>

      <activity xml:id="nsetintersection" category="essential">
        <statement>
          <p>
            Conjecture a formula for the size of a union of sets
            <me>
              A_1\cup
              A_2\cup \cdots\cup A_n = \bigcup_{i=1}^n A_i
            </me>
            in terms of the sizes of
            the sets <m>A_i</m> and their intersections.
          </p>
        </statement>
        <solution>
            <p>
                <me>
            \left|\bigcup_{i=1}^n A_i\right| = \sum_{i=1}^n|A_i| -
            \sum_{i=1}^n\sum_{j=i+1}^n |A_i \cap A_j| + \cdots +(-1)^{n-1} |A_1\cap
            A_2\cap\cdots \cap A_n|.
                </me>
            </p>
        </solution>
      </activity>

      <p>
        The difficulty of generalizing <xref ref="threesetintersection"/> and
        <xref ref="nsetintersection"/> is not likely to be one of being able to
        see what the right conjecture is, but of finding a good notation to
        express your conjecture. In fact, it would be easier for some people to
        express the conjecture in words than to express it in a notation. Here
        is some notation that will make your task easier. Let us define
        <me>
          \bigcap_{i:i\in I}A_i
        </me>
        to mean the intersection over all elements <m>i</m>
        in the set <m>I</m> of
        <m>A_i</m>. Thus
        <men xml:id="intersectionnotation" >
          \bigcap_{i:i\in
          \{1,3,4,6\}} = A_1\cap A_3\cap A_4 \cap A_6.
        </men>
      </p>

      <p>
        This kind of notation, consisting of an operator with a description
        underneath of the values of a dummy variable of interest to us, can be
        extended in many ways. For example
        <mdn>
          <mrow number="no">\sum_{I:I \subseteq \{1,2,3,4\}, \ |I|=2} |\cap_{i\in I}
          A_i|  \amp =  |A_1\cap A_2|+ |A_1\cap A_3|
           +|A_1\cap A_4|</mrow>
          <mrow xml:id="notationsolution"> \amp +  |A_2\cap A_3|+
          |A_2\cap A_4| +|A_3\cap A_4|.</mrow>
        </mdn>
      </p>

      <exploration xml:id="inclusion-exclusionunion" category="essential">
        <statement>
          <p>
            Use notation something like that of <xref ref="intersectionnotation">Equation</xref> and <xref ref="notationsolution">Equation</xref> to express
            the answer to <xref ref="nsetintersection"/>. Note there are many
            different correct ways to do this problem. Try to write down more
            than one and choose the nicest one you can. Say why you chose it
            (because your view of what makes a formula nice may be different from
            somebody else's). The nicest formula won't necessarily involve all the
            elements of <xref ref="intersectionnotation">Equations</xref> and <xref ref="notationsolution"></xref>.
          </p>
        </statement>
        <solution>
            <p><me>
            \left|\bigcup_{i=1}^n A_i\right| = \sum_{S:S\subseteq [n],
            S\not=\emptyset}(-1)^{|S|-1}|\bigcap_{i: i\in S}A_i|
          </me>
            I chose this
            way of writing the formula partly because it is efficient with symbols;
            for example, it uses only one sum sign. But more importantly I chose it
            because it captures what I would want to say in words: ``You sum, over
            all ways of choosing an intersection of the sets <m>A_i</m>, the size of the
            intersection times a sign factor that is -1 if you are intersecting
            an even number of sets and 1 if you are intersecting an odd number."
            If I were writing my solution out in words, I would probably assume
            that nobody would think about the possibility of an intersection of the
            empty set of the
            <m>A_i</m>s, but I had to put the <m>S\not=\emptyset</m> in my formula because
            otherwise the formula would have had us consider the possibility that
            <m>S</m> was empty.
          </p>
        </solution>
      </exploration>

      <p>
        Whether we try to write down a nice expression for the size of a union or whether we just have the basic idea, we should now be able to answer counting questions like the following.  We will return to this sort of problem in more detail later, but the adventurous reader can attempt it here.
      </p>


      <exploration xml:id="hatcheck" category="essential">
          <introduction>
              <p>
            A group of <m>n</m> students goes to a restaurant carrying backpacks.
            The manager invites everyone to check their backpack at the check desk and everyone does. While they are eating, a child playing in the check room randomly moves around the claim check stubs on the backpacks. We will try to compute the probability that, at the end of the meal, at least one student receives his or her own backpack.  This probability is the fraction of the total number of ways to return the backpacks in which at least one student gets his or her own backpack back.
              </p>
          </introduction>
        <task>
          <statement>
            <p>
              What is the total number of ways to pass back the backpacks?
            </p>
          </statement>
          <solution>
            <p>
              <m>n!</m>, because there are <m>n</m> students and <m>n</m> backpacks and a distribution of backpacks to students will be a bijection.
            </p>
          </solution>
        </task>

        <task>
          <statement>
            <p>
              In how many of the distributions of backpacks to students does at least one student get his or her own backpack?
            </p>
          </statement>
          <hint>
            <p>
              For each student, how big is the set of backpack distributions in which that student gets the correct backpack?  It might be a good idea to first consider cases with <m>n=3</m>, <m>4</m>, and <m>5</m>.
            </p>
          </hint>

          <hint>
            <p>
              For each pair of students (say Mary and Jim, for example) how big is
              the set of backpack distributions in which the students in this pair
              get the correct backpack. What does the question have to do with
              unions or intersections of sets. Keep on increasing the number of
              students for which you ask this kind of question.
            </p>
          </hint>
          <solution>
            <p>
              If we let <m>A_i</m> be the set of backpack distributions in which student
              <m>i</m> gets the correct backpack, then the number we want to compute is
              the size of the union of the sets <m>A_i</m>. For this purpose we need to
              know, for every subset <m>S\subseteq [n]</m> the size of <m>\cap_{i\in S}A_i</m>.
              That is, we need to know the number of ways to pass out the backpacks
              so that student <m>i</m> gets the correct one for each <m>i</m> in <m>S</m>. It
              won't matter whether or not other students get the correct backpacks,
              so we can just assume that for each <m>i\in S</m>, student <m>i</m> gets the
              correct backpack and then hand out the remaining <m>n-|S|</m> backpacks to
              the remaining <m>n-|S|</m> students in <m>(n-|S|)!</m> ways. Thus <m>(n-|S|)!</m> is
              <m>|\cap_{i:i\in S}A_i|</m>. Using our formula from <xref ref="inclusion-exclusionunion"/> we get
              <md>
                <mrow>\left|\bigcup_{i=1}^n A_i \right|  =\amp  \sum_{S:
                S\subseteq [n], S\not=\emptyset}
                (-1)^{|S|-1}\left|\bigcap_{i:i\in S} A_i \right|</mrow>
                <mrow> =\amp \sum_{S:
                S\subseteq [n], S\not=\emptyset}(-1)^{|S|-1} (n-|S|)!</mrow>
                <mrow> =\amp
                \sum_{s=1}^n \binom{n}{s}(-1)^{s-1}(n-s)!</mrow>
                <mrow> =\amp \sum_{s=1}^n
                (-1)^{s-1}\frac{n!}{s!}</mrow>
              </md>
            </p>
          </solution>
        </task>

        <task>
          <statement>
            <p>
              What is the probability that at least one student gets the correct backpack?
            </p>
          </statement>
          <solution>
            <p>
              Dividing the answer in the last part by <m>n!</m>, the total number of ways to pass back the backpacks, we get <m>\sum_{s=1}^n \frac{(-1)^{s-1}}{s!}</m> for the probability that at least one student gets the correct backpack.
            </p>
          </solution>
        </task>

        <task xml:id="hatcheckprobpart">
          <statement>
            <p>
              What is the probability that no student gets his or her own backpack?
            </p>
          </statement>
          <solution>
            <p>
              Subtracting from 1 to get the probability that no student gets the correct backpack gives us
              <me>
                1-\sum_{s=1}^n  \frac{(-1)^{s-1}}{s!} = \sum_{s=0}^n \frac{(-1)^s}{s!}.
              </me>
            </p>
          </solution>
        </task>

      <task category="interesting">
        <statement>
          <p>
            As the number of students becomes large, what does the probability
            that no student gets the correct backpack approach?
          </p>
        </statement>
        <solution>
          <p>
            From calculus, we know that <m>e^x=\sum_{j=0}^\infty \frac{x^j}{j!}</m>. Substituting <m>x=-1</m> gives us <m>e^{-1}=\sum_{j=0}^\infty
            \frac{(-1)^j}{j!}</m> which is the limit as <m>n</m> becomes infinite of the
            probability in the solution to <xref ref="hatcheck"/>. Thus the
            probability approaches <m>1/e</m>.
          </p>
        </solution>
      </task>
    </exploration>

      <p>
        <xref ref="hatcheck"/> is <q>classically</q> called the <term>hatcheck
        problem</term><idx><h>hatcheck problem</h></idx>; the name comes from substituting hats
        for backpacks. If is also sometimes called the <term>derangement
        problem</term><idx><h>derangement problem</h></idx>. A <term>derangement</term><idx><h>derangement</h></idx> of an
        <m>n</m>-element set is a permutation of that set (thought of as a bijection)
        that maps no element of the set to itself. One can think of a way of
        handing back the backpacks as a permutation <m>f</m> of the students: <m>f(i)</m> is
        the owner of the backpack that student <m>i</m> receives. Then a derangement
        is a way to pass back the backpacks so that no student gets his or her
        own.
      </p>


    </subsection>

    <subsection>
      <title>The Principle of Inclusion and Exclusion</title>

      <p>
        The formula you have given in <xref ref="inclusion-exclusionunion"/> is
        often called <term>the principle of inclusion and
        exclusion</term><idx><h>inclusion and exclusion principle
        </h><h>for unions of sets</h></idx><idx><h>principle of inclusion and exclusion</h><h>for
        unions of sets</h></idx> for unions of sets. The reason is the pattern in which
        the formula first adds (includes) all the sizes of the sets, then
        subtracts (excludes) all the sizes of the intersections of two sets, then
        adds (includes) all the sizes of the intersections of three sets, and so
        on.   Notice that we haven't yet proved the principle. There are a variety of proofs.  Perhaps one of the most straightforward (though not the most elegant) is an inductive proof that relies on the fact that
        <me>
          A_1 \cup A_2 \cup \cdots \cup A_n = \left(A_1 \cup A_2 \cup \cdots \cup A_{n-1}\right) \cup A_n
        </me>
        and the formula for the size of a union of two sets: <m>\card{A \cup B} = \card{A} + \card{B} - \card{A\cap B}</m>.
      </p>

      <exploration>
        <statement>
          <p>
            Give a proof of your formula for the principle of inclusion and exclusion.
          </p>
        </statement>
        <hint>
          <p>
            Try induction.
          </p>
        </hint>
        <hint>
          <p>
            We can apply the formula of <xref ref="twosetintersection"/> to get
            <md>
            <mrow> \left|\bigcup_{i=1}^n A_i \right| \amp = \left|\left(\bigcup_{i=1}^{n-1} A_i\right) \cup A_n \right| </mrow>
            <mrow> \amp = \left| \bigcup_{i=1}^{n-1} A_i\right| + |A_n| - \left|\left( \bigcup_{i=1}^{n-1} A_i\right) \cap A_n\right|</mrow>
            <mrow> \amp = \left| \bigcup_{i=1}^{n-1} A_i\right| + |A_n| - \left|\bigcup_{i=1}^{n-1} A_i \cap A_n\right|</mrow>
            </md>
          </p>
        </hint>

        <solution>
          <p>
            The principle of inclusion and exclusion for one set says <m>|A_1| = |A_1|</m>.  The principle of inclusion and exclusion for two sets says <m>|A_1\cup A_2| = |A_1| + |A_2| - |A_1 \cap A_2|</m>, and was prove in our solution to <xref ref="twosetintersection"/>.  Now suppose the formula is true for a union of <m>n-1</m> or fewer sets and <m>n \ge 2</m>.  Since
            <me>
              A_1 \cup A_2 \cup \cdots \cup A_n = \left(A_1 \cup A_2 \cup \cdots \cup A_{n-1}\right) \cup A_n
            </me>
            we can apply the formula of <xref ref="twosetintersection"/> to get

            <md>
            <mrow> \left|\bigcup_{i=1}^n A_i \right| \amp = \left|\left(\bigcup_{i=1}^{n-1} A_i\right) \cup A_n \right| </mrow>
            <mrow> \amp = \left| \bigcup_{i=1}^{n-1} A_i\right| + |A_n| - \left|\left( \bigcup_{i=1}^{n-1} A_i\right) \cap A_n\right|</mrow>
            <mrow> \amp = \left| \bigcup_{i=1}^{n-1} A_i\right| + |A_n| - \left|\bigcup_{i=1}^{n-1} A_i \cap A_n\right|</mrow>
            </md>

            By the inductive hypothesis, we may apply the principle of inclusion and exclusion to the first and last term in the last line above, and can rewrite it as
            <md>
            <mrow>
            \sum_{S:S\subseteq [n-1],S\ne \emptyset} (-1)^{|S|-1}\left|\bigcap_{i:i\in S}A_i \right| + |A_n| - \sum_{S:S\subseteq [n-1],S\ne \emptyset} (-1)^{|S|-1}\left|\bigcap_{i:i\in S}A_i \cap A_n \right|
            </mrow>
            <mrow>
            = \sum_{S:S\subseteq [n],S\ne \emptyset} (-1)^{|S|-1}\left|\bigcap_{i:i\in S}A_i \right|,
            </mrow>
            </md>
            where the last line follows because every nonempty subset of <m>[n]</m> is either (1) a nonempty subset of <m>[n-1]</m>, (2) a nonempty subset of <m>[n-1]</m> with  <m>n</m> added in, or (3) the set <m>\{n\}</m>.  Thus by the principle of mathematical induction, the formula for the principle of inclusion and exclusion holds for all nonnegative integers <m>n</m>.
          </p>
        </solution>
      </exploration>




          <p>
            Frequently when we apply the principle of inclusion and exclusion, we will have a situation like that of part (d) of <xref ref="hatcheckprobpart" />.  That is, we will have a set <m>A</m> and subsets <m>A_1, A_2, \ldots, A_n</m> and we will want the size or the probability of the set of elements in <m>A</m> that are <em>not</em> in the union.  This set is known as the <term>complement</term> <idx><h>complement</h></idx> of the union of the <m>A_i</m>s in <m>A</m>, and is denoted by <m>A \setminus \bigcup_{i=1}^n A_i</m>, or if <m>A</m> is clear from context, by <m>\overline{\bigcup_{i=1}^n A_i}</m>.
          </p>
          <p>
            Since all the <m>A_i</m>s are subsets of <m>A</m>, one way to write this size is as <m>|A| - \sum_{S:S \subseteq [n], S \ne \emptyset}(-1)^{|S|-1} |\bigcap_{i:i \in S}A_i|</m>.  Letting <m>|A| = \left|\bigcap_{i:i \in \emptyset} A_i\right|</m>, we may write <m>\left|\overline{\bigcup_{i=1}^n A_i}\right| = \sum_{S:S \subseteq [n]} (-1)^{|S|}\left| \bigcap_{i:i\in S} A_i\right|</m>.
          </p>
          <!-- <p>
            We can find a very elegant way of writing the formula in <xref ref="nsetintersection"/> if we let <m>\bigcap_{i:i\in\emptyset}A_i = A</m>.  for this reason, if we have a family of subsets <m>A_i</m> of a set <m>A</m>, we define<fn>
            For those interested in logic and set theory, given a family of subsets <m>A_i</m> of a set <m>A</m>, we define <m>\bigcap_{i:i\in S}A_i</m> to be the set of all members <m>x</m> of <m>A</m> that are in <m>A_i</m> for all <m>i \in S</m>.  (Note that this allows <m>x</m> to be in some other <m>A_j</m>s as well.)  Then if <m>S = \emptyset</m>, our intersection consists of all members <m>x</m> of <m>A</m> that satisfy the statement <q>if <m>i\in \emptyset</m>, then <m>x \in A_i</m>.</q>
            But since the hypothesis of the <q>if-then</q> statement is false, the statement itself is true for all <m>x \in A</m>.  Therefore <m>\bigcap_{i:i \in \emptyset}A_i = A</m>.
          </fn> <m>\bigcap_{i:i\in\emptyset}A_i = A</m>.
        </p> -->
          <p>
            The principle of inclusion and exclusion generally refers to both this formula and the one for the union.  Both formulas are notationally horrific, but the idea is straight forward.  To find the size of the union, we add the sizes of each set individually, then subtract each of the sizes of the intersections of pairs of sets, then add back in the sizes of the intersections of triples of sets, subtract 4-tuple intersections, add 5-tuple intersections, and so on until we are done.  The compliment can be calculated by subtracting the union from the size of the original set.
          </p>




    </subsection>



    <subsection xml:id="subsec_apps-of-pie">
    <title>Application of Inclusion and Exclusion</title>
    <paragraphs>
      <title>Multisets with restricted numbers of elements</title>

        <exploration xml:id="act_restrictedmultisetspie">
          <statement>
            <p>
              In how many ways may we distribute <m>k</m> identical apples to <m>n</m>
              children so that no child gets more than four apples?
            </p>
          </statement>
          <hint>
            <p>
          Notice that it is straightforward to figure out how many ways we may pass
          out the apples so that child <m>i</m> gets five or more apples: give five apples to
          child <m>i</m> and then pass out the remaining apples however you choose. And if  we want to figure out how many ways we may pass out the apples so that a given set <m>C</m> of children each get five or more apples, we give five to each child in <m>C</m> and then pass out the remaining <m>k-5|C|</m> apples however we choose.
            </p>
          </hint>
          <solution>
            <p>
                Let <m>S</m> be the set of all distributions of <m>k</m> identical apples to the <m>n</m> children. Let <m>A_i</m> be the set of distributions in which child <m>i</m> gets five or more apples. Then
              we are asking for the number of distributions of apples that lie in none of the sets, so we are asking for <m>|\overline{A_1\cup A_2\cup \cdots \cup A_n}|</m>. From the formula you gave in
              <xref ref="nsetintersection" /> we see that to find this number we need to know
              <m>|\bigcap_{i\in S}A_i|</m> for every subset <m>S</m> of <m>[n]</m>. But if
              <m>S</m> has size <m>s</m>, then <m>S</m> determines a distribution such that all the children in a particular set of size <m>s</m> will get five or more apples. We can pass out the apples so that the children in a particular set
              <m>\hat S</m> of children get at least five apples as follows: we give everyone in <m>\hat
              S</m> five apples, and then pass out the remaining <m>k-5s</m> apples to the
              children in <m>\binom{k-5s+n-1}{k-5s}= \binom{k-5s+n-1}{n-1}</m> ways. This
              counts the number of ways to give at least five apples to every child in
              <m>\hat S</m>, and maybe give five apples to some other children as well. Thus
              <m>|\bigcap_{i\in S}A_i| = = \binom{k-5|S|+n-1}{n-1}</m>. In particular, if <m>S=\emptyset</m>, we get <m>\binom{k+n-1}{n-1}</m>, which is the total number of ways to pass out <m>k</m> identical apples to <m>n</m> children. Applying the formula from <xref ref="nsetintersection" /> gives us
              <md>
                <mrow>\left| \overline{\bigcup_{i=1}^n A_i}\right|&amp;= \sum_{S:S\subseteq [n]}(-1)^{|S|}\left|\bigcap _{i\colon i\in S} A_i\right|</mrow>
                <mrow> &amp;= \sum_{s=0}^n \binom{n}{s}(-1)^s \binom{k-5s+n-1}{n-1}</mrow>
                <mrow> &amp;= \sum_{s=0}^n (-1)^s\binom{n}{s}\binom{k-5s+n-1}{n-1}</mrow>
              </md>.
            </p>
          </solution>
      </exploration>
  </paragraphs>

  <paragraphs xml:id="sec-menage">
    <title>The Menage Problem</title>
      <exploration xml:id="relaxedmenage" category="interesting">
        <statement>
          <p>
            A group of <m>n</m> married couples comes to a group discussion session
            where they all sit around a round table. In how many ways can they sit
            so that no person is next to his or her spouse?
            (Note that two people of the same sex can sit next to
            each other.)
          </p>
        </statement>
        <hint>
          <p>
            Start with two questions that can apply to any inclusion-exclusion
            problem. Do you think you would be better off trying to compute the
            size of a union of sets or the size of a complement of a union of
            sets? What kinds of sets (that are conceivably of use to you) is it
            easy to compute the size of? (The second question can be interpreted
            in different ways, and for each way of interpreting it, the answer may
            help you see something you can use in solving the problem.)
          </p>
        </hint>
        <hint>
          <p>
        Suppose we have a set <m>S</m> of couples whom we want to seat side by side. We can think of lining up <m>|S|</m> couples and <m>2n - 2|S|</m> individual people in a circle.  In how many ways can we arrange this many items in a circle?
          </p>
        </hint>
        <solution>
          <p>
            Let <m>A</m> be the set of all seating arrangements for <m>2n</m> people around a round table. Let <m>A_i</m> be the set of arrangements in which couple <m>i</m> sits together. We are interested in <m>|\overline{A_1\cup A_2\cup \cdots \cup A_n}|</m>. Thus, for a set <m>S\subseteq [n]</m>, we need to compute <m>\left|\bigcup_{i\colon i\in S} A_i\right|</m>. If we let each couple described by <m>S</m> sit together,
            we will seat <m>|S|</m> couples and <m>2n-2|S|</m> individuals around the table. We
            can do this in <m>2^{|S|}(|S| + 2n-2 |S|-1)!</m> ways, because once we chose a
            place for a couple (<ie />, two adjacent seats) there are two ways the couple
            can sit down. Thus as long as <m>S</m> is nonempty, we have the right formula for <m>\left|\bigcap_{i\colon i\in S} A_i\right|</m>. Notice that in the case where <m>S=\emptyset</m> the formula gives us <m>(2n-1)!</m> seating arrangements, which is exactly the number of ways to seat <m>2n</m> people around a round table. This is the size of our set <m>A</m>. Therefore,
            <me>\left|\bigcap_{i\colon i\in S} A_i\right| = 2^{|S|}(2n-|S|-1)!
            </me>.
            Substituting this into the formula from <xref ref="nsetintersection" /> gives us
            <md>
              <mrow>\left|\overline{\bigcup_{i=1}^n A_i}\right| &amp;=  \sum_{S:S\subseteq [n]}
              (-1)^{|S|} \left|\bigcap_{i\colon i\in S} A_i\right|</mrow>
              <mrow> &amp;= \sum_{s=0}^n(-1)^s\binom{n}{s}2^{s}(2n- s-1)!</mrow>
            </md>.
          </p>
        </solution>
      </exploration>

      <exploration category="interesting and difficult">
        <statement>
          <p>
            A group of <m>n</m> married couples comes to a group
            discussion session where they all sit around a round table. In how many
            ways can they sit so that no person is next to his or her spouse or a
            person of the same sex? This problem is called the <term>menage
            problem</term>.<idx><h>menage problem</h></idx>
          </p>
        </statement>
        <hint>
            <p>
                Reason somewhat as you did in <xref ref="relaxedmenage" />, noting that if the set of couples who do sit side-by-side is nonempty, then the sex of the person at each place at the table is determined once we seat one couple in that set.
            </p>
        </hint>
        <hint>
          <p>
            Think in terms of the sets <m>A_i</m> of arrangements of people in which couple <m>i</m> sits side-by-side. What does the union of the sets <m>A_i</m> have to do with the problem?
          </p>
        </hint>
        <solution>
          <p>
            We are going to consider arrangements of the couples alternating
            sex around the table. This will be our set <m>A</m>. The set <m>A_i</m> is the set of arrangements in which couple <m>i</m> sits together. We are interested in the number of arrangements that are in none of these sets. Thus for each subset <m>S</m> of <m>[n]</m>, we consider the number of arrangements in <m>\displaystyle\bigcap_{i\colon i\in S} A_i</m>. We distinguish the case that <m>S</m> is empty from the
            others. The number of arrangements with <m>S</m> empty is just the number of ways to seat <m>2n</m>
            couples around the table, alternating sex, but with no other
            restrictions. We can arrange one of the sexes in a circle in <m>n-1!</m> ways
            and then assign the members of the opposite sex to the places between them
            in <m>n!</m> ways, so <m>\displaystyle \left|\bigcap_{i\colon i\in \emptyset} A_i \right| = (n-1)!n!</m>. (Another way to
            get this result is to let one person sit down. This determines the sex
            of the person at each place of the table, so there are <m>(n-1)!</m> ways to
            assign the people of the same sex of the first person, and <m>n!</m> ways to
            assign the people of the opposite. It appears that there are <m>2n</m>
            choices for where the first person sits, but we can break the seating
            charts up into blocks of <m>2n</m> seating charts, each of which gives the
            same circular arrangement. Thus there are <m>(n-1)!n!</m> inequivalent seating arrangments.)
          </p>

          <p>
            Now if
            <m>S</m> is nonempty, and has <m>s</m> members, we seat one of the couples that must
            sit together (say the first in alphabetical order), and this determines the
            sex of the person that must sit at each other place. There are <m>2n</m> pairs
            of adjacent seats where we can seat that couple and two ways they can sit
            in the pair of adjacent seats that we choose. Then we have <m>s-1</m> couples,
            <m>n-s</m> men and <m>n-s</m> women to seat in the remaining places. First we
            arrange the <m>s-1</m> couples and <m>2n-2s</m> identical empty chairs in places at
            the table in <m>(2n-2s+s-1)!/(2n-2s)!=(2n-s-1)!/(2n-2s)!</m> ways. Each couple
            can sit in only one way in the places they have chosen, because the sex of
            the person in a given place has been determined by how the first couple
            sits. The sex of the person in each of the remaining chairs has been
            determined, so we assign the men to their seats in <m>(n-s)!</m> ways and we
            assign the women to their seats in <m>(n-s)!</m> ways. Thus we have
            <m>2\cdot2n(2n-s-1)!(n-s)!^2/(2n-2s)!</m> ways to place the people. But we can
            partition the placements into blocks of <m>2n</m> equivalent placements,
            because shifting everyone the same number of places to the right or left
            gives an equivalent placement. Thus the number of inequivalent seating
            arrangements is
            <md>
              <mrow>\frac{2(2n-s-1)!(n-s)!^2}{(2n-2s)!} =\amp \frac{2(2n-s-1)!(n-s)!^2}{2(n-s)(2n-2s-1)!}</mrow>
              <mrow> =\amp \frac{(2n-s-1)!(n-s)!(n-s-1)!}{(2n-2s-1)!}.</mrow>
            </md>
          </p>

          <p>
            Notice that
            if we take
            <m>s=0</m>, this formula reduces to <m>(n-1)!n!</m>. Thus for all sets <m>S</m>
            <me>
              \left|\bigcap_{i\colon i\in S} A_i\right|=\frac{(2n-s-1)!(n-s)!(n-s-1)!}{(2n-2s-1)!}
            </me>.
          </p>

          <p>
            Then from <xref ref="nsetintersection" />
            <md>
              <mrow>\left|\overline{\bigcup_{i=1}^n A_i}\right|  &amp;= \sum_{S:S\subseteq [n]} (-1)^{|S|}\frac{(2n-|S|-1)!(n-|S|)!(n-|S|-1)!
              }{(2n-2|S|-1)!}</mrow>
              <mrow> =\amp \sum_{s=0}^n(-1)^s\binom{n}{s}\frac{(2n-s-1)!(n-s)!(n-s-1)!}{(2n-2s-1)!}</mrow>
              <mrow> =\amp \sum_{s=0}^n(-1)^s\frac{n!}{s!(n-s)!}\frac{(2n-s-1)!(n-s)!(n-s-1)!}{(2n-2s-1)!}</mrow>
              <mrow> =\amp \sum_{s=0}^n(-1)^s \frac{n!(2n-s-1)!(n-s-1)!}{s!(2n-2s-1)!}</mrow>
              <mrow> =\amp \sum_{s=0}^n(-1)^s\binom{2n-s-1}{s}n!(n-s-1)!</mrow>
            </md>
            is the number of ways to seat the people, alternating sex, so
            that no couple sits together.
          </p>
        </solution>
      </exploration>
    </paragraphs>

    <paragraphs xml:id="subsec_derangements">
      <title>Counting Derangements</title>
      <p>
        A <term>derangement</term><idx><h>derangement</h></idx> of <m>n</m> elements <m>\{1,2,3,\ldots, n\}</m> is a permutation in which no element is fixed. For example, there are <m>6</m> permutations of the three elements <m>\{1,2,3\}</m>:
        <me>
          123 ~~ 132 ~~ 213 ~~ 231 ~~ 312 ~~ 321.
        </me>
        but most of these have one or more elements fixed: <m>123</m> has all three elements fixed since all three elements are in their original positions, <m>132</m> has the first element fixed (1 is in its original first position), and so on. In fact, the only derangements of three elements are
        <me>
          231 \text{ and } 312.
        </me>
      </p>

      <p>
        If we go up to 4 elements, there are <m>4! = 24</m> permutations. How many of these are derangements? If you list out all 24 permutations and eliminate those which are not derangements, you will be left with just 9 derangements. Let's see how we can get that number using PIE.
      </p>
      <activity>
        <task>
          <statement>
            <p>
              Write out all 24 permutations of <m>[4]</m> and circle the 9 that are derangements.
            </p>
          </statement>
          <hint>
            <p>
              Note that 2341 should be circled, but 2314 should not be circled.
            </p>
          </hint>
        </task>
        <task>
          <statement>
            <p>
              Locate the permutations that leave 1 fixed (so 1 is the first number in the permutation).  How many are there, and does this make sense?  Check there are an equal number that leave 2 fixed, and that leave 3 fixed, and that leave 4 fixed.
            </p>
          </statement>
        </task>
        <task>
          <statement>
            <p>
              Notice that there are permutations that leave both 1 and 2 fixed.  Which ones are these, and how many are there?  Again, verify that there are just as many that leave any pair of numbers fixed.
            </p>
          </statement>
        </task>
        <task>
          <statement>
            <p>
              Repeat the previous task for triples of elements fixed and for all four elements fixed.
            </p>
          </statement>
        </task>
        <task>
          <statement>
            <p>
              We can use the principle of inclusion and exclusion to find the total number of derangements as follows:
              <me>
                d_4 = 4! - \left[{4 \choose 1}3! - {4 \choose 2}2! + {4 \choose 3} 1! - {4 \choose 4}0!\right].
              </me>
              Explain why this is correct.  In particular, for the permutation 1234 (where everything is fixed), where in the expression above is it counted?
            </p>
          </statement>
        </task>
        <solution>
          <p>
            We count all permutations, and subtract those which are not derangements. There are <m>4! = 24</m> permutations of 4 elements. Now for a permutation to <em>not</em> be a derangement, at least one of the 4 elements must be fixed. There are <m>{4 \choose 1}</m> choices for which single element we fix. Once fixed, we need to find a permutation of the other three elements. There are <m>3!</m> permutations on 3 elements. But now we have counted too many non-derangements, so we must subtract those permutations which fix two elements. There are <m>{4 \choose 2}</m> choices for which two elements we fix, and then for each pair, <m>2!</m> permutations of the remaining elements. But this subtracts too many, so add back in permutations which fix 3 elements, all <m>{4 \choose 3}1!</m> of them. Finally subtract the <m>{4 \choose 4}0!</m> permutations (recall <m>0! = 1</m>) which fix all four elements. All together we get that the number of derangements of 4 elements is:
            <me>
              4! - \left[{4 \choose 1}3! - {4 \choose 2}2! + {4 \choose 3} 1! - {4 \choose 4}0!\right] = 24 - 15 = 9.
            </me>
          </p>
        </solution>
      </activity>
      
      
      <p>
        Of course we can use a similar formula to count the derangements of any number of elements. However, the more elements we have, the longer the formula gets. Here is another example:
      </p>
      <exploration>
        <statement>
          <p>
            Five gentlemen attend a party, leaving their hats at the door. At the end of the party, they hastily grab hats on their way out. How many different ways could this happen so that none of the gentlemen leave with their own hat?
          </p>
        </statement>
        <solution>
          <p>
            We are counting derangements on 5 elements. There are <m>5!</m> ways for the gentlemen to grab hats in any order<mdash/>but many of these permutations will result in someone getting their own hat. So we subtract all the ways in which one or more of the men get their own hat. In other words, we subtract the non-derangements. Doing so requires PIE. Thus the answer is:
            <me>
              5! - \left[{5 \choose 1}4! - {5 \choose 2}3! + {5 \choose 3}2! - {5 \choose 4}1! + {5 \choose 5}0!\right].
            </me>
          </p>
        </solution>
      </exploration>

      <p>
        Derangments are interesting in their own right.  In <xref ref="sec_basic-proofs"/> you proved a few results using combinatorial proofs.  In particular, we established the following, which you might try to prove again here.
      </p>
      
      <theorem xml:id="thm-derangement-recursion">
        <statement>
          <p>
            Let <m>d_n</m> denote the number of derangments of <m>n</m>, with <m>d_0 = 1</m> and <m>d_1 = 0</m>.  Then <m>d_n = (n-1)(d_{n-1}+d_{n-2})</m>.
          </p>
        </statement>
      </theorem>
      
      <theorem xml:id="thm-derangment-sum">
        <statement>
          <p>
            Let <m>d_n</m> denote the number of derangments of <m>n</m>, with <m>d_0 = 1</m> and <m>d_1 = 0</m>.  Then
            <me>
              \binom{n}{0}d_0 + \binom{n}{1}d_1 + \binom{n}{2}d_2 + \cdots + \binom{n}{n}d_n = n!
            </me>
          </p>
        </statement>
      </theorem>
      
      <p>
        Here is another recursion you can explore.
      </p>
      
      <exploration>
        <statement>
          <p>
            Use the principle of inclusion and exclusion to derive the recursion
            <me>
              d_n = nd_{n-1} + (-1)^n
            </me>.
          </p>
        </statement>
      </exploration>
      
      <p>
        The non-recursive formula for derangments is messy due to the use of the principle of inclusion and exclusion.  Actually, it can be cleaned up a bit, which leads to a remarkable result.
      </p>
      
      <exploration>
        <task>
          <statement>
            <p>
              We know that <m>d_3 = 3! - \left(\binom{3}{1}2! - \binom{3}{2}1! + \binom{3}{3}0! \right)</m>.  Use the factorial formula for <m>\binom{n}{k}</m> to simplify this.  Factor out a <m>3!</m> leaving terms that are each nice unit fractions.
            </p>
          </statement>
        </task>
        <task>
          <statement>
            <p>
              Generalize the previous part to give a nice clean expression for <m>d_n</m>.
            </p>
          </statement>
        </task>
        <task>
          <statement>
            <p>
              The alternating sum of unit fractions you get might look familiar if you have thought about Taylor series from calculus recently.  For large <m>n</m>, what fraction of all permutations are derangements?
            </p>
          </statement>
          <hint>
            <p>
              The Taylor series for <m>e^x</m> is <m>1+x + \frac{1}{2!}x^2 + \frac{1}{3!}x^3 + \cdots</m>.  What happens if you replace <m>x</m> with <m>-1</m>?
            </p>
          </hint>
        </task>
      </exploration>
      


    </paragraphs>

    <paragraphs>
      <title>Counting surjective functions</title>
      
      <p> 
        There are six surjective functions  <m>f:[3]\to [2]</m>, which happens to be <m>2^3 - 2</m>.  This makes sense because there are eight functions all together, but two are not surjective (do you see why?).
      </p>
    
      <p>
        Consider functions <m>f:[3]\to [3]</m>.  Since each element of the domain has three potential images, there are <m>3^3</m> such functions.  If we only count the injective (one-to-one) functions, we will find <m>3! = 6</m>.  Since the size of the domain and codomain are equal, this is also the number of surjective functions (since every injective function is surjective in this case).  
      </p>
      
      <p>
        However, when the size of the codomain is larger than the size of the domain, there will be no injections and plenty of surjections.  To see how to count surjections in general, let's explore the case above where we know the answer already. 
      </p>
      <activity>
        <introduction>
          Write out all 27 functions <m>f:[3] \to [3]</m>.  You could use two-line notation here, but to save space, perhaps just write the bottom line.  So the function that sends 1 to 1, 2 to 3 and 3 to 3 can be represented as (1,3,3). 
        </introduction>
        <task>
          <p>
            Circle the functions you found above that are surjective.  Verify that there are just 6.
          </p>
        </task>
        <task>
          <p>
            There are various ways that a function might fail to be surjective.  One way is for 1 to not be in the range.  How many functions are there like this (identify them)?  Does this number make sense?  Check this is the same number of functions that do not include 2 in the range.
          </p>
        </task>
        <task>
          <p>
            How many functions do not have 1 or 2 in the range?  Does this number make sense as well?
          </p>
        </task>
        <task>
          <p>
            Explain what all this has to do with the expression 
            <me>
              3^3 - \left[ \binom{3}{1}2^3 - \binom{3}{2}1^3 + \binom{3}{3}0^3\right]
            </me>.
          </p>
        </task>
      </activity>
      
      <p>
        Let's generalize!
      </p>
      
      <activity xml:id="numontofun" category="essential">
        <statement>
          <p>
            Given a function <m>f</m> from the <m>k</m>-element set <m>K</m> to the
            <m>n</m>-element set <m>[n]</m>, we say <m>f</m> is in the set <m>A_i</m> if <m>f(x)\not= i</m> for
            any <m>x</m> in
            <m>K</m>. 
          </p>
          <p>
            How many of these sets does a surjective function belong to? 
          </p>
          <p>
            Use this to find the number of functions from a <m>k</m>-element set onto an <m>n</m>-element
            set?<idx><h>onto functions</h><h>number of</h></idx><idx><h>surjections</h><h>number
            of</h></idx><idx><h>functions</h><h>onto!number of</h></idx>
          </p>
        </statement>
        <solution>
          <p>
            An onto function is in none of these sets. Since we want the number of functions that are in none of these sets, we let our set <m>A</m> be the set of all functions from <m>K</m> to <m>[n]</m>. Then the number of onto functions is <m>|\overline{A_1\cup A_2\cup \cdots \cup A_n}|</m>. For a nonempty subset <m>S</m> of <m>[n]</m>, the set <m>\bigcap_{i\colon i\in S} A_i</m> is the set of functions functions from <m>K</m> to <m>[n]-S</m>. The size of this set
             is <m>(n-|S|)^k</m>. When <m>S=\emptyset</m> this gives the size of <m>A</m>. Thus by <xref ref="nsetintersection" />
            <md>
              <mrow>\left|\overline{\bigcup_{i=1}^n A_i}\right|&amp;=  \sum_{S:s\subseteq [n]} (-1)^{|S|}
              (n-|S|)^k</mrow>
              <mrow> &amp;= \sum_{s=0}^n (-1)^s\binom{n}{s}(n-s)^k</mrow>
            </md>
            is the number of functions from <m>K</m> onto <m>[n]</m>.
          </p>
        </solution>
      </activity>

    

<!-- 
      <activity category="interesting" xml:id="act_stirlingpie">
        <statement>
          <p>
            Find a formula for the Stirling number (of the second kind)
            <m>S(k,n)</m>.<idx><h>Stirling Number</h><h>second kind</h></idx>
          </p>
        </statement>
        <hint>
          <p>
        What does <xref ref="numontofun"/> have to do with this question?
          </p>
        </hint>
        <solution>
          <p>
            Since the number of functions from <m>[k]</m> onto <m>[n]</m> is <m>S(k,n)n!</m>,
            we get from the solution to <xref ref="numontofun"/>
            <me>
              S(k,n) = \frac{1}{n!}\sum_{s=0}^n (-1)^s\binom{n}{s}(n-s)^k.
            </me>
          </p>
        </solution>
      </activity> -->
      
      
      <exploration>
          <introduction>
              <p>
                  If we roll a die eight times, we get a sequence of 8 numbers, the number of dots on top on the first roll, the number on the second roll, and so on.
              </p>
          </introduction>
          <task>
              <statement>
                  <p>
                      What is the number of ways of rolling the die eight times so that each of the numbers one through six appears at least once in our sequence? To get a numerical answer, you will likely need a computer algebra package.
                  </p>
              </statement>
              <solution>
                  <p>
                      By the formula for the number of onto functions, we have <m>\sum_{s=0}^6 (-1)^s\binom{6}{s}(6-s)^8</m> sequences in which each number between one and six appears. Courtesy of Maple, this number is 191,520.
                  </p>
              </solution>
          </task>
          <task>
              <statement>
                  <p>
                     What is the probability that we get a sequence in which all six numbers between one and six appear? To get a numerical answer, you will likely need a computer algebra package, programmable calculator, or spreadsheet.
                  </p>
              </statement>
              <solution>
                  <p>
                      <m>191520/6^8</m>, which is about <m>.1140260631</m>, courtesy of Maple.
                  </p>
              </solution>
          </task>
          <task>
              <statement>
                  <p>
                      How many times do we have to roll the die to have probability at least one half that all six numbers appear in our sequence? To answer this question, you will likely need a computer algebra package, programmable calculator, or spreadsheet.
                  </p>
              </statement>
              <solution>
                  <p>
                      Some experimenting with Maple shows that if we roll our die 13 times, we get probability approximately <m>.5138581940</m> of having all six numbers appear, but with 12 rolls the probability is approximately <m>.4378156806</m>. Thus, 13 rolls are required.
                  </p>
              </solution>
          </task>

      </exploration>


  </paragraphs>
</subsection>

</section>
